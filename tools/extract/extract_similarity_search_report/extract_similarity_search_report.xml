<tool id="extract_similarity_search" name="Extract from similarity search report">

	<macros>
		<xml name="BLAST_6_options">
			<option value="query">Query id</option>
			<option value="target">Target id</option>
			<option value="identity_percentage">Identity percentage</option>
			<option value="alignment_length">Alignment length</option>
			<option value="mismatch_number">Mismatch number</option>
			<option value="open_gap_number">Open gap number</option>
			<option value="query_start_pos">Starting position of alignment on query sequence</option>
			<option value="query_end_pos">Ending position of alignment on query sequence</option>
			<option value="target_start_pos">Starting position of alignment on target sequence</option>
			<option value="target_end_pos">Ending position of alignment on target sequence</option>
			<option value="e_value">E-value</option>
			<option value="bit_score">Bit score</option>
		</xml>
		<xml name="BLAST_6_CIGAR_options">
			<expand macro="BLAST_6_options" />
			<option value="cigar_string">Cigar string</option>
		</xml>
		<xml name="BLAST_6_CIGAR_Coverage_options">
			<expand macro="BLAST_6_CIGAR_options" />
			<option value="coverage">Coverage percentage</option>
		</xml>
		<xml name="constrain_number">
       		<param name="type_constraint" type="select" label="Type of constraint">
				<option value="equal">Equal to </option>
				<option value="lower">Lower than </option>
				<option value="strictly_lower">Strictly lower than </option>
				<option value="greater">Greater than </option>
				<option value="strictly_greater">Strictly greater than </option>
			</param>
     	</xml>
     	<xml name="constrain_string">
     		<conditional name="type_constrain">
				<param name="type_constrain" type="select" label="Type of constraint" multiple="true" display="radio">
					<option value="equal">Equal a value</option>
					<option value="in">In a list</option>
					<option value="not_in">Not in a list</option>
				</param>

				<when value="equal">
					<param name="constraint_value" type="text" label="Equal to" size="200"/>
				</when>
				<when value="in">
					<param format="txt" name="constraint_value" type="data" label="List of constraint" help="Text file with a value per line and nothing else"/>
				</when>
				<when value="not_in">
					<param format="txt" name="constraint_value" type="data" label="List of constraint" help="Text file with a value per line and nothing else"/>
				</when>
			</conditional>
		</xml>
		<xml name="constrain_query">
			<when value="query">
				<expand macro="constrain_string" />
			</when>
		</xml>
		<xml name="constrain_target">
			<when value="target">
				<expand macro="constrain_string" />
			</when>
		</xml>
		<xml name="constrain_identity_percentage">
			<when value="identity_percentage">
				<repeat name="constraint_definition" title="Constraint on identity percentage" min="1">
					<expand macro="constrain_number" />
				  	<param name="constraint_value" type="float" label="Value" min="0" max="100" value="97"/>
				</repeat>
			</when>
		</xml>
		<xml name="constrain_alignment_length">
			<when value="alignment_length">
				<repeat name="constraint_definition" title="Constraint on alignment length" min="1">
					<expand macro="constrain_number" />
				  	<param name="constraint_value" type="integer" label="Value" min="0" max="1000" value="10"/>
				</repeat>
			</when>
		</xml>
		<xml name="constrain_mismatch_number">
			<when value="mismatch_number">
				<repeat name="constraint_definition" title="Constraint on mismatch number" min="1">
					<expand macro="constrain_number" />
				  	<param name="constraint_value" type="integer" label="Value" min="0" max="1000" value="10"/>
				</repeat>
			</when>
		</xml>
		<xml name="constrain_open_gap_number">
			<when value="open_gap_number">
				<repeat name="constraint_definition" title="Constraint on open gap number" min="1">
					<expand macro="constrain_number" />
				  	<param name="constraint_value" type="integer" label="Value" min="0" max="1000" value="10"/>
				</repeat>
			</when>
		</xml>
		<xml name="constrain_query_start_pos">
			<when value="query_start_pos">
				<repeat name="constraint_definition" title="Constraint on starting position of alignment on query" min="1">
					<expand macro="constrain_number" />
				  	<param name="constraint_value" type="integer" label="Value" min="0" max="1000" value="10"/>
				</repeat>
			</when>
		</xml>
		<xml name="constrain_query_end_pos">
			<when value="query_end_pos">
				<repeat name="constraint_definition" title="Constraint on ending position of alignment on query" min="1">
					<expand macro="constrain_number" />
				  	<param name="constraint_value" type="integer" label="Value" min="0" max="1000" value="10"/>
				</repeat>
			</when>
		</xml>
		<xml name="constrain_target_start_pos">
			<when value="target_start_pos">
				<repeat name="constraint_definition" title="Constraint on starting position of alignment on target" min="1">
					<expand macro="constrain_number" />
				  	<param name="constraint_value" type="integer" label="Value" min="0" max="1000" value="10"/>
				</repeat>
			</when>
		</xml>
		<xml name="constrain_target_end_pos">
			<when value="target_end_pos">
				<repeat name="constraint_definition" title="Constraint on ending position position of alignment on target" min="1">
					<expand macro="constrain_number" />
				  	<param name="constraint_value" type="integer" label="Value" min="0" max="1000" value="10"/>
				</repeat>
			</when>
		</xml>
		<xml name="constrain_e_value">
			<when value="e_value">
				<repeat name="constraint_definition" title="Constraint on e-value" min="1">
					<expand macro="constrain_number" />
				  	<param name="constraint_value" type="float" label="Value" min="0" max="1000" value="10"/>
				</repeat>
			</when>
		</xml>
		<xml name="constrain_bit_score">
			<when value="bit_score">
				<repeat name="constraint_definition" title="Bit score" min="1">
					<expand macro="constrain_number" />
				  	<param name="constraint_value" type="integer" label="Value" min="0" max="1000" value="10"/>
				</repeat>
			</when>
		</xml>
		<xml name="constrain_cigar_string">
			<when value="cigar_string">
				<expand macro="constrain_string" />
			</when>
		</xml>
		<xml name="constrain_coverage_percentage">
			<when value="coverage">
				<repeat name="constraint_definition" title="Constraint on coverage percentage" min="1">
					<expand macro="constrain_number" />
				  	<param name="constraint_value" type="float" label="Value" min="0" max="100" value="97"/>
				</repeat>
			</when>
		</xml>
		<xml name="BLAST_6_constraints">
			<expand macro="constrain_query" />
			<expand macro="constrain_target" />
			<expand macro="constrain_identity_percentage" />
			<expand macro="constrain_alignment_length" />
			<expand macro="constrain_mismatch_number" />
			<expand macro="constrain_open_gap_number" />
			<expand macro="constrain_query_start_pos" />
			<expand macro="constrain_query_end_pos" />
			<expand macro="constrain_target_start_pos" />
			<expand macro="constrain_target_end_pos" />
			<expand macro="constrain_e_value" />
			<expand macro="constrain_bit_score" />
		</xml>
		<xml name="BLAST_6_CIGAR_constraints">
			<expand macro="BLAST_6_constraints" />
			<expand macro="constrain_cigar_string" />
		</xml>
		<xml name="BLAST_6_CIGAR_Coverage_constraints">
			<expand macro="BLAST_6_CIGAR_constraints" />
			<expand macro="constrain_coverage_percentage" />
		</xml>
   	</macros>

	<description></description>

	<requirements>
    	<container type="docker">asaim/extract-similarity-search-report</container> 
  	</requirements>

  	<command>
  		extract_similarity_search_report.py 
  		--input=$similarity_report
  		--format=$extracted_information.format

  		#*#for $to_extract in $extracted_information.info_to_extract:
  			--to_extract=$to_extract
  		#end for

  		#if str( $extracted_information.extraction_constraints.contrained_extraction ) == "yes":
  			#for $constrain in $extracted_information.extraction_constraints.constraint_definition
  				#set constrained_information=$constrain.info_to_constrained
  				#if str( $constrained_information ) in ("query", "target", "constrain_cigar_string"):
  					--constraint="${constrained_information}:${constrain.type_constrain}:${constrain.constraint_value}"
  				#else:
  					#for $sub_constrain in $constrain.constraint_definition
  						--constraint="${constrained_information}:${constrain.type_constrain}:${constrain.constraint_value}"
  					#end for
  				#end if
  			#end for
  		#end if*#

  		--report=$report_filepath
  		--output=$output_filepath
  	</command>

  	<inputs>
  		<param format="txt" name="similarity_report" type="data" label="Similarity search report" help=""/>

        <conditional name="extracted_information">
        	<param name="format" type="select" label="Format of the similarity search report" display="radio">
	            <option value="BLAST_6">BLAST 6</option>
	            <option value="BLAST_6_CIGAR">BLAST 6 + CIGAR</option>
	            <option value="BLAST_6_CIGAR_Coverage">BLAST 6 + CIGAR + Coverage</option>
	        </param>
		    <when value="BLAST_6">
		    	<param name="info_to_extract" type="select" label="Information to extract" multiple="true" display="checkboxes">
		    		<expand macro="BLAST_6_options" />
		    		<validator type="no_options" message="Select at least one database"/>
				</param>
				<conditional name="extraction_constraints">
					<param name="contrained_extraction" type="select" label="Constrain extraction?" display="radio">
						<option value="no">No</option>
						<option value="yes">Yes</option>
					</param>
					<when value="yes">
						<repeat name="constraint_definition" title="Constraints on similarity" min="1">
							<conditional name="constrained_information">
								<param name="info_to_constrained" type="select" label="Information to constrain">
									<expand macro="BLAST_6_options" />
								</param>
							<expand macro="BLAST_6_constraints" />
							</conditional>
						</repeat>
					 </when>
				</conditional>
		    </when>
		    <when value="BLAST_6_CIGAR">
		    	<param name="info_to_extract" type="select" label="Information to extract" multiple="true" display="checkboxes">
		    		<expand macro="BLAST_6_CIGAR_options" />
				</param>
				<conditional name="extraction_constraints">
					<param name="contrained_extraction" type="select" label="Constrain extraction?" display="radio">
						<option value="no">No</option>
						<option value="yes">Yes</option>
					</param>
					<when value="yes">
						<repeat name="constraint_definition" title="Constraints on similarity" min="1">
							<conditional name="constrained_information">
								<param name="info_to_constrained" type="select" label="Information to constrain">
									<expand macro="BLAST_6_CIGAR_options" />
								</param>
								<expand macro="BLAST_6_CIGAR_constraints" />
							</conditional>
						</repeat>
					 </when>
				</conditional>
		    </when>
		    <when value="BLAST_6_CIGAR_Coverage">
		    	<param name="info_to_extract" type="select" label="Information to extract" multiple="true" display="checkboxes">
		    		<expand macro="BLAST_6_CIGAR_Coverage_options" />
				</param>
				<conditional name="extraction_constraints">
					<param name="contrained_extraction" type="select" label="Constrain extraction?" display="radio">
						<option value="no">No</option>
						<option value="yes">Yes</option>
					</param>
					<when value="yes">
						<repeat name="constraint_definition" title="Constraints on similarity" min="1">
							<conditional name="constrained_information">
								<param name="info_to_constrained" type="select" label="Information to constrain">
									<expand macro="BLAST_6_CIGAR_Coverage_options" />
								</param>
							<expand macro="BLAST_6_CIGAR_Coverage_constraints" />
							</conditional>
						</repeat>
					 </when>
				</conditional>
		    </when>
		</conditional>

  	</inputs>

  	<outputs>
  		<data format="txt" name="report_filepath" />
  		<data format="txt" name="output_filepath" />
  	</outputs>

  	<requirements>
  	</requirements>

  	<tests>
  		<test>
  			<param name="similarity_report" value="blast_6_output.txt"/>
  			<param name="format" value="BLAST_6"/>
  			<param name="info_to_extract" value="query,identity_percentage,e_value"/>
  			<param name="contrained_extraction" value="no"/>
  			<output name="report_filepath" file="blast_6_simple_extraction_report.txt" />
  			<output name="output_filepath" file="blast_6_simple_extraction_output.txt" />
  		</test>
  	</tests>

  	<help>

  	</help>
</tool>

