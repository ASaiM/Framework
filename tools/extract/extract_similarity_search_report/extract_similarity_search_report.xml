<tool id="extract_similarity_search" name="Extract (constrained) information">

	<description>from similarity search report</description>

    <macros>
        <xml name="blast_6_7_10_default_options">
            <option value="qseqid">Query Seq-id (qseqid)</option>
            <option value="sseqid">Subject Seq-id (sseqid)</option>
            <option value="pident">Percentage of identical matches (pident)</option>
            <option value="length">Alignment length (length)</option>
            <option value="mismatch">Number of mismatches (mismatch)</option>
            <option value="gapopen">Number of gap openings (gapopen)</option>
            <option value="qstart">Start of alignment in query (qstart)</option>
            <option value="qend">End of alignment in query (qend)</option>
            <option value="sstart">Start of alignment in subject (sstart)</option>
            <option value="send">End of alignment in subject (send)</option>
            <option value="evalue">Expect value (evalue)</option>
            <option value="bitscore">Bit score (bitscore)</option>
        </xml>
        <xml name="blast_6_7_10_default_options_cigar">
            <expand macro="blast_6_7_10_default_options" />
            <option value="cigar">CIGAR string</option>
        </xml>
        <xml name="blast_6_7_10_default_options_cigar_coverage">
            <expand macro="blast_6_7_10_default_options_cigar" />
            <option value="coverage">Coverage percentage</option>
        </xml>

        <xml name="test_constrain_extraction">
            <param name='constrained_extraction' type='boolean' checked="false" truevalue='yes' falsevalue='no' label="Constrain extraction?" help=""/>
        </xml>
        <xml name="constrain_number">
            <param name="type" type="select" label="Type of constraint" help="">
                <option value="equal">Equal to </option>
                <option value="lower">Lower than </option>
                <option value="strictly_lower">Strictly lower than </option>
                <option value="greater">Greater than </option>
                <option value="strictly_greater">Strictly greater than </option>
            </param>
        </xml>
        <xml name="constrain_string">
            <conditional name="constraint_type">
                <param name="type" type="select" display="radio" label="Type of constraint" help="">
                    <option value="equal">Equal a value</option>
                    <option value="in">In a list</option>
                    <option value="not_in">Not in a list</option>
                </param>
                <when value="equal">
                    <param name="value" type="text" size="200" label="Equal to" help=""/>
                    <validator type="empty_field" message="Give a value"/>
                </when>
                <when value="in">
                    <param format="txt" name="value" type="data" label="List of constraint" help="Text file with a value per line and nothing else"/>
                    <validator type="unspecified_build" message="Select a file"/>
                </when>
                <when value="not_in">
                    <param format="txt" name="value" type="data" label="List of constraint" help="Text file with a value per line and nothing else"/>
                    <validator type="unspecified_build" message="Select a file"/>
                </when>
            </conditional>
        </xml>
        <xml name="constrain_query">
            <when value="qseqid">
                <expand macro="constrain_string" />
            </when>
        </xml>
        <xml name="constrain_target">
            <when value="sseqid">
                <expand macro="constrain_string" />
            </when>
        </xml>
        <xml name="constrain_identity_percentage">
            <when value="pident">
                <repeat name="constraint_definition" title="Constraint on identity percentage" min="1">
                    <expand macro="constrain_number" />
                    <param name="value" type="float" min="0" max="100" value="97" label="Value" help=""/>
                </repeat>
            </when>
        </xml>
        <xml name="constrain_alignment_length">
            <when value="length">
                <repeat name="constraint_definition" title="Constraint on alignment length" min="1">
                    <expand macro="constrain_number" />
                    <param name="value" type="integer"  min="0" max="1000" value="10" label="Value" help=""/>
                </repeat>
            </when>
        </xml>
        <xml name="constrain_mismatch_number">
            <when value="mismatch">
                <repeat name="constraint_definition" title="Constraint on mismatch number" min="1">
                    <expand macro="constrain_number" />
                    <param name="value" type="integer" min="0" max="1000" value="10" label="Value" help=""/>
                </repeat>
            </when>
        </xml>
        <xml name="constrain_open_gap_number">
            <when value="gapopen">
                <repeat name="constraint_definition" title="Constraint on open gap number" min="1">
                    <expand macro="constrain_number" />
                    <param name="value" type="integer" min="0" max="1000" value="10" label="Value" help=""/>
                </repeat>
            </when>
        </xml>
        <xml name="constrain_query_start_pos">
            <when value="qstart">
                <repeat name="constraint_definition" title="Constraint on starting position of alignment on query" min="1">
                    <expand macro="constrain_number" />
                    <param name="value" type="integer" min="0" max="1000" value="10" label="Value" help=""/>
                </repeat>
            </when>
        </xml>
        <xml name="constrain_query_end_pos">
            <when value="qend">
                <repeat name="constraint_definition" title="Constraint on ending position of alignment on query" min="1">
                    <expand macro="constrain_number" />
                    <param name="value" type="integer" min="0" max="1000" value="10" label="Value" help=""/>
                </repeat>
            </when>
        </xml>
        <xml name="constrain_target_start_pos">
            <when value="sstart">
                <repeat name="constraint_definition" title="Constraint on starting position of alignment on target" min="1">
                    <expand macro="constrain_number" />
                    <param name="value" type="integer" min="0" max="1000" value="10" label="Value" help=""/>
                </repeat>
            </when>
        </xml>
        <xml name="constrain_target_end_pos">
            <when value="send">
                <repeat name="constraint_definition" title="Constraint on ending position position of alignment on target" min="1">
                    <expand macro="constrain_number" />
                    <param name="value" type="integer" min="0" max="1000" value="10" label="Value" help=""/>
                </repeat>
            </when>
        </xml>
        <xml name="constrain_e_value">
            <when value="evalue">
                <repeat name="constraint_definition" title="Constraint on e-value" min="1">
                    <expand macro="constrain_number" />
                    <param name="value" type="float" min="0" max="1000" value="10" label="Value" help=""/>
                </repeat>
            </when>
        </xml>
        <xml name="constrain_bit_score">
            <when value="bitscore">
                <repeat name="constraint_definition" title="Bit score" min="1">
                    <expand macro="constrain_number" />
                    <param name="value" type="integer" min="0" max="1000" value="10" label="Value" help=""/>
                </repeat>
            </when>
        </xml>
        <xml name="constrain_cigar_string">
            <when value="cigar">
                <expand macro="constrain_string" />
            </when>
        </xml>
        <xml name="constrain_coverage_percentage">
            <when value="coverage">
                <repeat name="constraint_definition" title="Constraint on coverage percentage" min="1">
                    <expand macro="constrain_number" />
                    <param name="value" type="float" min="0" max="100" value="97" label="Value" help=""/>
                </repeat>
            </when>
        </xml>
        <xml name="blast_6_7_10_default_constraints">
            <expand macro="constrain_query" />
            <expand macro="constrain_target" />
            <expand macro="constrain_identity_percentage" />
            <expand macro="constrain_alignment_length" />
            <expand macro="constrain_mismatch_number" />
            <expand macro="constrain_open_gap_number" />
            <expand macro="constrain_query_start_pos" />
            <expand macro="constrain_query_end_pos" />
            <expand macro="constrain_target_start_pos" />
            <expand macro="constrain_target_end_pos" />
            <expand macro="constrain_e_value" />
            <expand macro="constrain_bit_score" />
        </xml>
        <xml name="blast_6_7_10_default_cigar_constraints">
            <expand macro="blast_6_7_10_default_constraints" />
            <expand macro="constrain_cigar_string" />
        </xml>
        <xml name="blast_6_7_10_default_cigar_coverage_constraints">
            <expand macro="blast_6_7_10_default_cigar_constraints" />
            <expand macro="constrain_coverage_percentage" />
        </xml>
        <xml name="blast_6_7_10">
            <conditional name="report_specifiers">
                <param name="use_default_specifiers" type="select" display="radio" label="Specifiers?" 
                    help="Default specifiers are (in order) ">
                    <option value="default">Default ('qseid sseqid piden length mismatch gapopen qstart qend sstart send evalue bitscore')</option>
                    <option value="cigar">Default + CIGAR string</option>
                    <option value="cigar_coverage">Default + CIGAR string + Coverage percentage</option>
                </param>
                <when value="default">
                    <!--<repeat name="specifiers" min="1" title="Format specifiers" help="Add the format specifiers in the order given to Blast">
                        <param name="specifier_selection" type="select" label="Specifier" help="">
                            <option value="qseqid">Query Seq-id (qseqid)</option>
                            <option value="qgi">Query GI (qgi)</option>
                            <option value="qacc">Query accesion (qacc)</option>
                            <option value="qaccver">Query accesion.version (qaccver)</option>
                            <option value="qlen">Query sequence length (qlen)</option>
                            <option value="sseqid">Subject Seq-id (sseqid)</option>
                            <option value="sallseqid">All subject Seq-id(s) (sallseqid)</option>
                            <option value="sgi">Subject GI (sgi)</option>
                            <option value="sallgi">All subject GIs (sallgi)</option>
                            <option value="sacc">Subject accession (sacc)</option>
                            <option value="saccver">Subject accession.version (saccver)</option>
                            <option value="sallacc">All subject accessions (sallacc)</option>
                            <option value="slen">Subject sequence length (slen)</option>
                            <option value="qstart">Start of alignment in query (qstart)</option>
                            <option value="qend">End of alignment in query (qend)</option>
                            <option value="sstart">Start of alignment in subject (sstart)</option>
                            <option value="send">End of alignment in subject (send)</option>
                            <option value="qseq">Aligned part of query sequence (qseq)</option>
                            <option value="sseq">Aligned part of subject sequence (sseq)</option>
                            <option value="evalue">Expect value (evalue)</option>
                            <option value="bitscore">Bit score (bitscore)</option>
                            <option value="score">Raw score (score)</option>
                            <option value="length">Alignment length (length)</option>
                            <option value="pident">Percentage of identical matches (pident)</option>
                            <option value="nident">Number of identical matches (nident)</option>
                            <option value="mismatch">Number of mismatches (mismatch)</option>
                            <option value="positive">Number of positive-scoring matches (positive)</option>
                            <option value="gapopen">Number of gap openings (gapopen)</option>
                            <option value="gaps">Total number of gaps (gaps)</option>
                            <option value="ppos">Percentage of positive-scoring matches (ppos)</option>
                            <option value="frames">Query and subject frames (frames)</option>
                            <option value="qframe">Query frame (qframe)</option>
                            <option value="sframe">Subject frame (sframe)</option>
                            <option value="btop">Blast traceback operations (BTOP, btop)</option>
                            <option value="staxids">Unique Subject Taxonomy ID(s) (staxids)</option>
                            <option value="sscinames">Unique Subject Scientific Name(s) (sscinames)</option>
                            <option value="scomnames">unique Subject Common Name(s) (scomnames)</option>
                            <option value="sblastnames">unique Subject Blast Name(s) (sblastnames)</option>
                            <option value="sskingdoms">unique Subject Super Kingdom(s) (sskingdoms)</option>
                            <option value="stitle">Subject Title (stitle)</option>
                            <option value="salltitles">All Subject Title(s) (salltitles)</option>
                            <option value="sstrand">Subject Strand (sstrand)</option>
                            <option value="qcovs">Query Coverage Per Subject (qcovs)</option>
                            <option value="qcovhsp">Query Coverage Per HSP (qcovhsp)</option>
                            <option value="cigar">CIGAR string</option>
                            <option value="coverage">Coverage percentage</option>
                        </param>
                    </repeat>-->
                    <param name="info_to_extract" type="select" multiple="true" display="checkboxes" label="Information to extract" help="Which columns will be in the output file">
                        <!--<options from_parameter="tool.app" >
                            <column name="value" index="0"/>
                            <column name="name" index="0"/>
                        </options>-->
                        <expand macro="blast_6_7_10_default_options" />
                        <validator type="no_options" message="Select at least one information to extract"/>
                    </param>
                    <conditional name="extraction_constraints">
                        <expand macro="test_constrain_extraction" />
                        <when value="yes">
                            <repeat name="constraint_definition" title="Constraints on similarity" min="1">
                                <conditional name="constrained_information">
                                    <param name="info_to_constrain" type="select" label="Information to constrain" help="">
                                        <expand macro="blast_6_7_10_default_options" />
                                    </param>
                                    <expand macro="blast_6_7_10_default_constraints" />
                                </conditional>
                            </repeat>
                         </when>
                    </conditional>
                </when>
                <when value="cigar">
                    <param name="info_to_extract" type="select" multiple="true" display="checkboxes" label="Information to extract" help="Which columns will be in the output file">
                        <expand macro="blast_6_7_10_default_options_cigar" />
                        <validator type="no_options" message="Select at least one information to extract"/>
                    </param>
                    <conditional name="extraction_constraints">
                        <expand macro="test_constrain_extraction" />
                        <when value="yes">
                            <repeat name="constraint_definition" title="Constraints on similarity" min="1">
                                <conditional name="constrained_information">
                                    <param name="info_to_constrain" type="select" label="Information to constrain" help="">
                                        <expand macro="blast_6_7_10_default_options_cigar" />
                                    </param>
                                    <expand macro="blast_6_7_10_default_cigar_constraints" />
                                </conditional>
                            </repeat>
                         </when>
                    </conditional>
                </when>
                <when value="cigar_coverage">
                    <param name="info_to_extract" type="select" multiple="true" display="checkboxes" label="Information to extract" help="Which columns will be in the output file">
                        <expand macro="blast_6_7_10_default_options_cigar_coverage" />
                        <validator type="no_options" message="Select at least one information to extract"/>
                    </param>
                    <conditional name="extraction_constraints">
                        <expand macro="test_constrain_extraction" />
                        <when value="yes">
                            <repeat name="constraint_definition" title="Constraints on similarity" min="1">
                                <conditional name="constrained_information">
                                    <param name="info_to_constrain" type="select" label="Information to constrain" help="">
                                        <expand macro="blast_6_7_10_default_options_cigar_coverage" />
                                    </param>
                                    <expand macro="blast_6_7_10_default_cigar_coverage_constraints" />
                                </conditional>
                            </repeat>
                         </when>
                    </conditional>
                </when>
            </conditional>
        </xml>
    </macros>

	<requirements>
  	</requirements>

    <stdio>
    </stdio>

    <version_command>python -version</version_command>

  	<!--<command>-->
    <command interpreter="python">
  		extract_similarity_search_report.py 
  		--input=$similarity_report
        --tool=$search_tool.tool
  		
        #set format=$search_tool.report_format.format
        --format=$format
        #if $format in ('6','7','10'):
            --use_default_specifiers=$search_tool.report_format.report_specifiers.use_default_specifiers
        #end if
        #set $extraction_constraint=$search_tool.report_format.report_specifiers
		--to_extract="{$extraction_constraint.info_to_extract}"
		#if $extraction_constraint.extraction_constraints.constrained_extraction :
            #for $i, $constrain in enumerate( $extraction_constraint.extraction_constraints.constraint_definition )
            	#set info_to_constrain=$constrain.constrained_information['info_to_constrain']             
                #if $info_to_constrain in ("qseqid", "sseqid", "cigar"):
                	--constraint="$info_to_constrain:
                	${constrain.constrained_information.constraint_type.type}:
                	${constrain.constrained_information.constraint_type.value}"
                #else:
                	#for $j, $sub_constrain in enumerate( $constrain.constrained_information.constraint_definition )
                		--constraint="$info_to_constrain:
                		${sub_constrain.type}:
                		${sub_constrain.value}"
                    #end for
                #end if
            #end for
        #end if

  		--report=$report_filepath
  		--output=$output_filepath
  	</command>

  	<inputs>
  		<param name="similarity_report" type="data" format="txt" label="Similarity search report" help="Text file containing the similarity search report"/>

        <conditional name="search_tool">
        	<param name="tool" type="select" display="radio" label="Tool used to generate the similarity search report" help="">
	            <option value="blast">Blast</option>
	        </param>
		    <when value="blast">
                <conditional name="report_format">
                    <param name="format" type="select" display="radio" label="Format" help="Alignment view options (-outfmt option)">
                        <!--<option value="0">Pairwise (-outfmt 0, default value in Blast)</option>-->
                        <!--<option value="1">Query-anchored showing identities (-outfmt 1)</option>-->
                        <!--<option value="2">Query-anchored no identities (-outfmt 2)</option>-->
                        <!--<option value="3">Flat query-anchored, show identities (-outfmt 3)</option>-->
                        <!--<option value="4">Flat query-anchored, no identities (-outfmt 4)</option>-->
                        <!--<option value="5">XML Blast output (-outfmt 5)</option>-->
                        <option value="6">Tabular (-outfmt 6)</option>
                        <option value="7">Tabular with comment lines (-outfmt 7)</option>
                        <!--<option value="8">Text ASN.1 (-outfmt 8)</option>-->
                        <!--<option value="9">Binary ASN.1 (-outfmt 9)</option>-->
                        <option value="10">Comma-separated values (-outfmt 10)</option>
                        <!--<option value="11">BLAST archive format (ASN.1) (-outfmt 11)</option>-->
                        <!--<option value="12">JSON Seqalign output (-outfmt 12)</option>-->
                    </param>
                    <when value="6">
                        <expand macro="blast_6_7_10" />
                    </when>
                    <when value="7">
                        <expand macro="blast_6_7_10" />
                    </when>
                    <when value="10">
                        <expand macro="blast_6_7_10" />
                    </when>
                </conditional>
		    </when>
        </conditional>
  	</inputs>

  	<outputs>
  		<data format="txt" name="report_filepath" label="${similarity_report}_report" />
  		<data format="txt" name="output_filepath" label="${similarity_report}_report" />
  	</outputs>

  	<tests>
  		<test>
  			<param name="similarity_report" value="blast_6_output.txt"/>
  			<param name="extracted_information.format" value="BLAST_6"/>
  			<param name="extracted_information.info_to_extract" value="query,target,identity_percentage"/>
  			<param name="extracted_information.extraction_constraints.constrained_extraction" value="no"/>
  			<output name="report_filepath" file="blast_6_simple_extraction_report.txt" />
  			<output name="output_filepath" file="blast_6_simple_extraction_output.txt" />
  		</test>
  	</tests>

  	<help>
        **What it does**

        This tool extracts information from reports generated by similarity 
        search programs such as Blast. 

        Some constraints could be added to extraction. For example, you choose 
        to extract only records for which the identity percentage is greater 
        than 40%.

        More information on ASaiM documentation...


        **Input**

        The input is one file in text format from Blast, with different output 
        formats.


        **Outputs**

        The tool generates 2 files:

            - an output file with the extracted information: one record per line, one information type per line
            - a report file with information about the extraction, the constraints, ...


        **Parameters**


  	</help>

    <citations>
    </citations>
</tool>

