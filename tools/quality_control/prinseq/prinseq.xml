<tool id="prinseq" name="Quality treatment">

	<description>with PRINSEQ</description>

    <macros>
        <xml name="fasta_option">
            <option value="id">Identifiant</option>
            <option value="length">Length</option>
            <option value="description">Description</option>
        </xml>
        <xml name="fastq_option">
            <expand macro="fasta_option" />
        </xml>
        <xml name="specific_extraction_test">
            <param name="specific_extraction" type="select" display="radio" label="Extract specific information?" help="If no is selected, a sequence file is generated. If yes, a text file containing the wanted information is generated">
                <option value="no">No</option>
                <option value="yes">Yes</option>
            </param>
        </xml>
        <xml name="test_constrain_extraction">
            <param name="constrained_extraction" type="select" display="radio" label="Constrain extraction?" help="">
                <option value="no">No</option>
                <option value="yes">Yes</option>
            </param>
        </xml>
        <xml name="constrain_string">
            <conditional name="constraint_type">
                <param name="type" type="select" display="radio" label="Type of constraint" help="">
                    <option value="equal">Equal a value</option>
                    <option value="in">In a list</option>
                    <option value="not_in">Not in a list</option>
                </param>
                <when value="equal">
                    <param name="value" type="text" size="200" label="Equal to" help=""/>
                    <validator type="empty_field" message="Give a value"/>
                </when>
                <when value="in">
                    <param format="txt" name="value" type="data" label="List of constraint" help="Text file with a value per line and nothing else"/>
                    <validator type="unspecified_build" message="Select a file"/>
                </when>
                <when value="not_in">
                    <param format="txt" name="value" type="data" label="List of constraint" help="Text file with a value per line and nothing else"/>
                    <validator type="unspecified_build" message="Select a file"/>
                </when>
            </conditional>
        </xml>
        <xml name="constrain_number">
            <param name="type" type="select" label="Type of constraint" help="">
                <option value="equal">Equal to </option>
                <option value="lower">Lower than </option>
                <option value="strictly_lower">Strictly lower than </option>
                <option value="greater">Greater than </option>
                <option value="strictly_greater">Strictly greater than </option>
            </param>
        </xml>
        <xml name="constraint_definitions">
            <conditional name="constraints">
                <expand macro="test_constrain_extraction" />
                <when value="yes">
                    <repeat name="constraint_definition" title="Constraints on sequences" min="1">
                        <conditional name="constrained_information">
                            <param name="info_to_constrain" type="select" label="Information to constrain" help="">
                                <option value="id">Identifiant</option>
                                <option value="length">Length</option>
                            </param>
                            <when value="id">
                                <expand macro="constrain_string" />
                            </when>  
                            <when value="length">
                                <repeat name="constraint_definition" title="Constraint on sequence length" min="1">
                                    <expand macro="constrain_number" />
                                    <param name="value" type="integer" min="0" max="3000" value="100" label="Value" help=""/>
                                </repeat>
                            </when>  
                        </conditional>
                    </repeat>
                 </when>
            </conditional>
        </xml>
    </macros>

	<requirements>
    	<!--<container type="docker">asaim/extract-similarity-search-report</container> -->
        <requirement type="package" version="0.1.1">extract_similarity_search</requirement>
  	</requirements>

    <stdio>
    </stdio>

    <version_command>python -version</version_command>

  	<!--<command>-->
    <command interpreter="perl">
  		src/prinseq-lite.pl

            -fastq $inuput_sequence_file

            #if $filter_treatments.apply_filter_treatments == 'yes':
                #set length_filter_treatments=$filter_treatments.length_filter_treatments
                #if $length_filter_treatments.apply_length_filter_treatments == 'yes':
                    #set min_length_filter_treatments=$length_filter_treatments.min_length_filter_treatments
                    #if $min_length_filter_treatments.apply_min_length_filter_treatments == 'yes':
                        -min_len $min_length_filter_treatments.value
                    #end if
                    #set max_length_filter_treatments=$length_filter_treatments.max_length_filter_treatments
                    #if $max_length_filter_treatments.apply_max_length_filter_treatments == 'yes':
                        -max_len $min_length_filter_treatments.value
                    #end if
                #end if

                #set quality_filter_treatments=$filter_treatments.quality_filter_treatments
                #if $quality_filter_treatments.apply_quality_filter_treatments == 'yes':
                    #set min_quality_filter_treatments=$quality_filter_treatments.min_quality_filter_treatments 
                    #if $min_quality_filter_treatments.apply_min_quality_filter_treatments== 'yes':
                        -min_qual_score $min_quality_filter_treatments.value
                    #end if
                    #set max_quality_filter_treatments=$quality_filter_treatments.max_quality_filter_treatments
                    #if $max_quality_filter_treatments.apply_max_quality_filter_treatments== 'yes':
                        -max_qual_score $max_quality_filter_treatments.value
                    #end if
                    #set mean_quality_filter_treatments=$quality_filter_treatments.mean_quality_filter_treatments
                    #if $mean_quality_filter_treatments.apply_mean_quality_filter_treatments== 'yes':
                        #set min_mean_quality_filter_treatments=$mean_quality_filter_treatments.min_mean_quality_filter_treatments
                        #if $min_mean_quality_filter_treatments.apply_min_mean_quality_filter_treatments== 'yes':
                            -min_qual_mean $min_mean_quality_filter_treatments.value
                        #end if
                        #set max_mean_quality_filter_treatments=$mean_quality_filter_treatments.max_mean_quality_filter_treatments
                        #if $max_mean_quality_filter_treatments.apply_max_mean_quality_filter_treatments== 'yes':
                            -max_qual_mean $max_mean_quality_filter_treatments.value
                        #end if
                    #end if
                #end if

                #set base_content_filter_treatments=$filter_treatments.base_content_filter_treatments
                #if $base_content_filter_treatments.apply_base_content_filter_treatments == 'yes':
                    #set GC_perc_content_filter_treatments=$base_content_filter_treatments.GC_perc_content_filter_treatments
                    #if $GC_perc_content_filter_treatments.apply_GC_perc_content_filter_treatments == 'yes':
                        #set min_GC_perc_content_filter_treatments=$GC_perc_content_filter_treatments.min_GC_perc_content_filter_treatments
                        #if $min_GC_perc_content_filter_treatments.apply_min_GC_perc_content_filter_treatments == 'yes':
                            -min_gc $min_GC_perc_content_filter_treatments.value
                        #end if
                        set max_GC_perc_content_filter_treatments=$GC_perc_content_filter_treatments.max_GC_perc_content_filter_treatments
                        #if $max_GC_perc_content_filter_treatments.apply_max_GC_perc_content_filter_treatments == 'yes':
                            -max_gc $max_GC_perc_content_filter_treatments.value
                        #end if
                    #end if
                    #set N_number_content_filter_treatments=$base_content_filter_treatments.N_number_content_filter_treatments
                    #if $N_number_content_filter_treatments.apply_N_number_content_filter_treatments == 'yes':
                        -ns_max_n $N_number_content_filter_treatments.value
                    #end if
                    #set N_percentage_content_filter_treatments=$base_content_filter_treatments.N_percentage_content_filter_treatments
                    #if $N_percentage_content_filter_treatments.apply_N_percentage_content_filter_treatments == 'yes':
                        -ns_max_p $N_percentage_content_filter_treatments.value
                    #end if
                    #if $base_content_filter_treatments.apply_other_base_content_filter_treatments == 'yes':
                        -noniupac
                    #end if
                #end if
            #end if
  	</command>

  	<inputs>
        <param name="inuput_sequence_file" type="data" format="fastq" label="Input sequence file" help="The file must be in fastq format for quality scores"/>

        <conditional name="filter_treatments">
        	<param name="apply_filter_treatments" type="select" display="radio" label="Apply filter treatments?" help="">
	            <option value="yes" selected="true">Yes</option>
                <option value="no">No</option>
	        </param>
		    <when value="yes">
                <conditional name="length_filter_treatments">
                    <param name="apply_length_filter_treatments" type="select" display="radio" label="Apply filter treatments based on sequence length?" help="By default, sequences smaller than 60 bp are removed. No top threshold is defined">
                        <option value="yes" selected="true">Yes</option>
                        <option value="no">No</option>
                    </param>    
                    <when value="yes">
                        <conditional name="min_length_filter_treatments">
                            <param name="apply_min_length_filter_treatments" type="select" display="radio" label="Remove too small sequences?" help="By default, sequences smaller than 60 bp are removed.">
                                <option value="yes" selected="true">Yes</option>
                                <option value="no">No</option>
                            </param>    
                            <when value="yes">
                                <param name="value" type="integer" min="0" max="3000" value="60" label="Minimum length threshold to conserve sequences" help=""/>
                            </when>
                        </conditional>  
                        <conditional name="max_length_filter_treatments">
                            <param name="apply_max_length_filter_treatments" type="select" display="radio" label="Remove too big sequences?" help="By default, no treatment based on a maximal length is made">
                                <option value="yes">Yes</option>
                                <option value="no" selected="true">No</option>
                            </param>    
                            <when value="yes">
                                <param name="value" type="integer" min="0" max="3000" value="3000" label="Maximal length threshold to conserve sequences" help=""/>
                            </when>
                        </conditional>  
                    </when>
                </conditional>  
                <conditional name="quality_filter_treatments">
                    <param name="apply_quality_filter_treatments" type="select" display="radio" label="Apply filter treatments based on quality score?" help="By default, sequences with a mean score below 15 are removed.">
                        <option value="yes" selected="true">Yes</option>
                        <option value="no">No</option>
                    </param>    
                    <when value="yes">
                        <conditional name="min_quality_filter_treatments">
                            <param name="apply_min_quality_filter_treatments" type="select" display="radio" label="Remove sequences based on their minimum score?" help="By default, no treatment based on a minimum score is made">
                                <option value="yes">Yes</option>
                                <option value="no" selected="true">No</option>
                            </param>    
                            <when value="yes">
                                <param name="value" type="integer" min="0" max="40" value="2" label="Minimum score threshold to conserve sequences" help=""/>
                            </when>
                        </conditional>
                        <conditional name="max_quality_filter_treatments">
                            <param name="apply_max_quality_filter_treatments" type="select" display="radio" label="Remove sequences based on their maximum score?" help="By default, no treatment based on a maximum score is made">
                                <option value="yes">Yes</option>
                                <option value="no" selected="true">No</option>
                            </param>    
                            <when value="yes">
                                <param name="value" type="integer" min="0" max="40" value="38" label="Maximum score threshold to conserve sequences" help=""/>
                            </when>
                        </conditional>
                        <conditional name="mean_quality_filter_treatments">
                            <param name="apply_mean_quality_filter_treatments" type="select" display="radio" label="Remove sequences based on their mean score?" help="By default, sequences with a mean score below 15 are removed.">
                                <option value="yes" selected="true">Yes</option>
                                <option value="no">No</option>
                            </param>    
                            <when value="yes">
                                <conditional name="min_mean_quality_filter_treatments">
                                    <param name="apply_min_mean_quality_filter_treatments" type="select" display="radio" label="Remove sequences with too small mean score?" help="By default, sequences with a mean score below 15 are removed.">
                                        <option value="yes" selected="true">Yes</option>
                                        <option value="no">No</option>
                                    </param> 
                                    <when value="yes">   
                                        <param name="value" type="integer" min="0" max="40" value="15" label="Minimum mean score threshold to conserve sequences" help=""/>
                                    </when>
                                </conditional>
                                <conditional name="max_mean_quality_filter_treatments">
                                    <param name="apply_max_mean_quality_filter_treatments" type="select" display="radio" label="Remove sequences with too high mean score?" help="By default, no treatment based on a maximum mean score is made">
                                        <option value="yes">Yes</option>
                                        <option value="no" selected="true">No</option>
                                    </param> 
                                    <when value="yes">   
                                        <param name="value" type="integer" min="0" max="40" value="40" label="Maximum mean score threshold to conserve sequences" help=""/>
                                    </when>
                                </conditional>
                            </when>
                        </conditional>
                    </when>
                </conditional>
                <conditional name="base_content_filter_treatments">
                    <param name="apply_base_content_filter_treatments" type="select" display="radio" label="Apply filter treatments based on base content?" help="By default, sequences with more than 2% of N bases are removed.">
                        <option value="yes" selected="true">Yes</option>
                        <option value="no">No</option>
                    </param>    
                    <when value="yes">
                        <conditional name="GC_perc_content_filter_treatments">
                            <param name="apply_GC_perc_content_filter_treatments" type="select" display="radio" label="Remove sequences based on their GC percentage?" help="By default, no treatment based on GC percentage is made.">
                                <option value="yes" >Yes</option>
                                <option value="no" selected="true">No</option>
                            </param>    
                            <when value="yes">
                                <conditional name="min_GC_perc_content_filter_treatments">
                                    <param name="apply_min_GC_perc_content_filter_treatments" type="select" display="radio" label="Remove sequences with too small GC percentage?" help="By default, no treatment based on GC percentage is made.">
                                        <option value="yes" >Yes</option>
                                        <option value="no" selected="true">No</option>
                                    </param>    
                                    <when value="yes">
                                        <param name="value" type="integer" min="0" max="100" value="50" label="Minimal GC percentage threshold to conserve sequences" help=""/>
                                    </when>
                                </conditional>
                                <conditional name="max_GC_perc_content_filter_treatments">
                                    <param name="apply_max_GC_perc_content_filter_treatments" type="select" display="radio" label="Remove sequences with too high GC percentage?" help="By default, no treatment based on GC percentage is made.">
                                        <option value="yes" >Yes</option>
                                        <option value="no" selected="true">No</option>
                                    </param>    
                                    <when value="yes">
                                        <param name="value" type="integer" min="0" max="100" value="50" label="Maximal GC percentage threshold to conserve sequences" help=""/>
                                    </when>
                                </conditional>
                            </when>
                        </conditional>
                        <conditional name="N_number_content_filter_treatments">
                            <param name="apply_N_number_content_filter_treatments" type="select" display="radio" label="Remove sequences based on their number of N bases?" help="By default, no treatment based on N number is made.">
                                <option value="yes" >Yes</option>
                                <option value="no" selected="true">No</option>
                            </param>    
                            <when value="yes">
                                <param name="value" type="integer" min="0" max="3000" value="50" label="Maximal N number threshold to conserve sequences" help=""/>
                            </when>
                        </conditional>
                        <conditional name="N_percentage_content_filter_treatments">
                            <param name="apply_N_percentage_content_filter_treatments" type="select" display="radio" label="Remove sequences based on their percentage of N bases?" help="By default, sequences with more than 2% of N bases are removed.">
                                <option value="yes" selected="true">Yes</option>
                                <option value="no" >No</option>
                            </param>    
                            <when value="yes">
                                <param name="value" type="integer" min="0" max="100" value="2" label="Maximal N percentage threshold to conserve sequences" help=""/>
                            </when>
                        </conditional>
                        <param name="apply_other_base_content_filter_treatments" type="select" display="radio" label="Remove sequences with characters other than A, T, C, G and N?" help="By default, this treatment is not made.">
                            <option value="yes">Yes</option>
                            <option value="no" selected="true">No</option>
                        </param>    

                    </when>
                </conditional>
            </when>
        </conditional>  
  	</inputs>

  	<outputs>
        <data format="fastq" name="output_sequence_file" label="treated_${inuput_sequence_file}" />
  	</outputs>

  	<tests>
  		<test>
  			<param name="sequence_file_format.sequence_file" value="read_write_fasta_file/input_sequence_file.fasta"/>
  			<param name="sequence_file_format.extraction.specific_extraction" value="no"/>
            <param name="$sequence_file_format.format" value="fasta" />
  			<output name="fasta_sequence_file" file="read_write_fasta_file/input_sequence_file.fasta"/>
  			<output name="report_filepath" file="read_write_fasta_file/expected_output_report.txt"/>
  		</test>
  	</tests>

  	<help>
        **What it does**

        PRINSEQ is a tool for easy and rapid quality control and data processing of metagenomic and metatranscriptomic datasets.
        This tool allow to process the sequences with filtering and trimming.


        **Input**

        The input is one file in fastq format.


        **Outputs**


        **Parameters**


  	</help>

    <citations>
    </citations>
</tool>

